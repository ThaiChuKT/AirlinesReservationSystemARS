@model ARS.ViewModels.BookingViewModel
@{
    ViewData["Title"] = "Complete Your Booking";
}

<div class="container mt-4">
    <div class="row">
        <div class="col-md-8">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">Passenger Information</h4>
                </div>
                <div class="card-body">
                    <form asp-action="Create" method="post">
                        <input type="hidden" asp-for="FlightID" />
                        <input type="hidden" asp-for="ScheduleID" />
                        <input type="hidden" asp-for="FlightNumber" />
                        <input type="hidden" asp-for="Origin" />
                        <input type="hidden" asp-for="Destination" />
                        <input type="hidden" asp-for="DepartureTime" />
                        <input type="hidden" asp-for="ArrivalTime" />
                        <input type="hidden" asp-for="TravelDate" />
                        <input type="hidden" asp-for="BasePrice" />
                        <input type="hidden" asp-for="TotalPrice" />
                        
                        <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

                        <div class="row g-3">
                            <div class="col-md-6">
                                <label asp-for="FirstName" class="form-label"></label>
                                <input asp-for="FirstName" class="form-control" readonly />
                                <span asp-validation-for="FirstName" class="text-danger"></span>
                            </div>
                            <div class="col-md-6">
                                <label asp-for="LastName" class="form-label"></label>
                                <input asp-for="LastName" class="form-control" readonly />
                                <span asp-validation-for="LastName" class="text-danger"></span>
                            </div>
                        </div>

                        <div class="row g-3 mt-2">
                            <div class="col-md-6">
                                <label asp-for="Email" class="form-label"></label>
                                <input asp-for="Email" class="form-control" type="email" readonly />
                                <span asp-validation-for="Email" class="text-danger"></span>
                            </div>
                            <div class="col-md-6">
                                <label asp-for="Phone" class="form-label"></label>
                                <input asp-for="Phone" class="form-control" type="tel" readonly />
                                <span asp-validation-for="Phone" class="text-danger"></span>
                            </div>
                        </div>

                        <hr class="my-4">

                        <h5 class="mb-3">Passenger Details</h5>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label asp-for="NumAdults" class="form-label"></label>
                                <input asp-for="NumAdults" class="form-control" type="number" min="1" max="10" />
                                <span asp-validation-for="NumAdults" class="text-danger"></span>
                            </div>
                            <div class="col-md-4">
                                <label asp-for="NumChildren" class="form-label"></label>
                                <input asp-for="NumChildren" class="form-control" type="number" min="0" max="10" />
                                <span asp-validation-for="NumChildren" class="text-danger"></span>
                            </div>
                            <div class="col-md-4">
                                <label asp-for="NumSeniors" class="form-label"></label>
                                <input asp-for="NumSeniors" class="form-control" type="number" min="0" max="10" />
                                <span asp-validation-for="NumSeniors" class="text-danger"></span>
                            </div>
                        </div>

                        <div class="row g-3 mt-2">
                            <div class="col-md-6">
                                <label asp-for="Class" class="form-label"></label>
                                <select asp-for="Class" class="form-select" id="ClassSelect" disabled>
                                    <option value="Economy">Economy</option>
                                    <option value="Business">Business</option>
                                    <option value="First">First Class</option>
                                </select>
                                <!-- Hidden input to actually post the class value because disabled inputs are not submitted -->
                                <input type="hidden" id="ClassHidden" name="Class" />
                                <span asp-validation-for="Class" class="text-danger"></span>
                            </div>
                        </div>

                        <div class="mt-4">
                            <input type="hidden" asp-for="SelectedSeat" id="SelectedSeat" />

                            <button type="button" class="btn btn-outline-secondary w-100 mb-2" id="btnToggleSeatMap">Select Seat</button>

                            <div id="seatMapContainer" class="mb-3" style="display:none;">
                                <div id="seatMap" class="border p-3" style="background:#fff; max-height:400px; overflow:auto"></div>
                                <p class="small mt-2"><span class="badge bg-success">&nbsp;</span> Available &nbsp; <span class="badge bg-danger">&nbsp;</span> Unavailable</p>
                            </div>

                            <button type="submit" class="btn btn-success btn-lg w-100">
                                <i class="bi bi-check-circle"></i> Confirm Booking
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card shadow-sm sticky-top" style="top: 20px;">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">Booking Summary</h5>
                </div>
                <div class="card-body">
                    <h6 class="text-primary">@Model.FlightNumber</h6>
                    <p class="mb-2">
                        <strong>@Model.Origin</strong> â†’ <strong>@Model.Destination</strong>
                    </p>
                    <p class="text-muted mb-2">
                        <i class="bi bi-calendar"></i> @Model.TravelDate.ToString("MMMM dd, yyyy")
                    </p>
                    <p class="text-muted mb-2">
                        <i class="bi bi-clock"></i> @Model.DepartureTime.ToString("HH:mm") - @Model.ArrivalTime.ToString("HH:mm")
                    </p>
                    
                    <hr>
                    
                    <div class="d-flex justify-content-between mb-2">
                        <span>Class:</span>
                        <strong>@Model.Class</strong>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Passengers:</span>
                        <strong>@Model.NumAdults</strong>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Price per person:</span>
                        <strong>$@Model.BasePrice.ToString("N2")</strong>
                    </div>
                    
                    <hr>
                    
                    <div class="d-flex justify-content-between">
                        <h5>Total:</h5>
                        <h5 class="text-success">$@Model.TotalPrice.ToString("N2")</h5>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
}

<script>
document.addEventListener('DOMContentLoaded', function(){
    const btn = document.getElementById('btnToggleSeatMap');
    const container = document.getElementById('seatMapContainer');
    const seatMap = document.getElementById('seatMap');
    const selectedSeatInput = document.getElementById('SelectedSeat');

    btn.addEventListener('click', async () => {
        if (container.style.display === 'none') {
            // fetch seat map
            const flightId = document.querySelector('input[name="FlightID"]').value;
            let travelDateRaw = document.querySelector('input[name="TravelDate"]').value;
            // normalize travel date to yyyy-MM-dd if possible
            try {
                if (travelDateRaw.includes('/')) {
                    const parts = travelDateRaw.split('/').map(p => p.trim());
                    if (parts.length === 3) travelDateRaw = `${parts[2]}-${parts[0].padStart(2,'0')}-${parts[1].padStart(2,'0')}`;
                }
            } catch (e) { /* ignore and send raw */ }

            const resp = await fetch(`/Reservation/GetSeatMap?flightId=${encodeURIComponent(flightId)}&travelDate=${encodeURIComponent(travelDateRaw)}`);
            const data = await resp.json();

            // render airplane-style rows
            seatMap.innerHTML = '';
            const seatGrid = document.createElement('div');
            seatGrid.className = 'seatmap-airplane';

            // determine class ranges: rows 1-10 First, 11-30 Business, 31+ Economy
            const firstEnd = 10;
            const businessEnd = 30;

            data.rowsResult.forEach(r => {
                // if this row should show a class header, insert it
                const rowNum = Number(r.row);
                if (!isNaN(rowNum)) {
                    if (rowNum === 1) {
                        const hdr = document.createElement('div');
                        hdr.className = 'seat-class-header mb-2';
                        hdr.textContent = 'First Class';
                        seatGrid.appendChild(hdr);
                    } else if (rowNum === firstEnd + 1) {
                        const hdr = document.createElement('div');
                        hdr.className = 'seat-class-header mb-2';
                        hdr.textContent = 'Business Class';
                        seatGrid.appendChild(hdr);
                    } else if (rowNum === businessEnd + 1) {
                        const hdr = document.createElement('div');
                        hdr.className = 'seat-class-header mb-2';
                        hdr.textContent = 'Economy Class';
                        seatGrid.appendChild(hdr);
                    }
                }
                const rowDiv = document.createElement('div');
                rowDiv.className = 'seat-row d-flex align-items-center mb-2';

                const rowLabel = document.createElement('div');
                rowLabel.className = 'seat-row-label me-3 fw-bold';
                rowLabel.textContent = r.row;
                rowDiv.appendChild(rowLabel);

                // wrap seats in a container so we can center them independent of the label width
                const seatsContainer = document.createElement('div');
                seatsContainer.className = 'seat-buttons d-flex flex-wrap align-items-center justify-content-center';

                r.seats.forEach(s => {
                    const seatBtn = document.createElement('button');
                    seatBtn.type = 'button';
                    seatBtn.className = 'btn btn-sm me-1';
                    seatBtn.style.width = '56px';
                    seatBtn.textContent = s.label;
                    seatBtn.title = `${s.label} - ${s.cabin}`;
                    if (s.available) {
                        seatBtn.classList.add('btn-success');
                        seatBtn.addEventListener('click', () => {
                            document.querySelectorAll('#seatMap button').forEach(b => b.classList.remove('border-primary'));
                            seatBtn.classList.add('border','border-primary');
                            selectedSeatInput.value = s.label;

                            // set class based on row number
                            const numericRow = parseInt(s.label, 10);
                            let seatClass = 'Economy';
                            if (!isNaN(numericRow)) {
                                if (numericRow <= firstEnd) seatClass = 'First';
                                else if (numericRow <= businessEnd) seatClass = 'Business';
                                else seatClass = 'Economy';
                            }
                            // set visible select (disabled) and hidden input used for POST
                            const classSelect = document.getElementById('ClassSelect');
                            const classHidden = document.getElementById('ClassHidden');
                            if (classSelect) {
                                classSelect.value = seatClass;
                            }
                            if (classHidden) {
                                classHidden.value = seatClass;
                            }
                        });
                    } else {
                        seatBtn.classList.add('btn-danger');
                        seatBtn.disabled = true;
                    }
                    seatsContainer.appendChild(seatBtn);

                    // insert aisle between C and D
                    if (s.col === 'C') {
                        const aisle = document.createElement('div');
                        aisle.className = 'seat-aisle';
                        seatsContainer.appendChild(aisle);
                    }
                });

                rowDiv.appendChild(seatsContainer);
                seatGrid.appendChild(rowDiv);
            });

            seatMap.appendChild(seatGrid);
            container.style.display = '';
            btn.textContent = 'Hide Seat Map';
        } else {
            container.style.display = 'none';
            btn.textContent = 'Select Seat';
        }
    });
});
</script>
